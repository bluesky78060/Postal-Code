# 프린텍 라벨 우편 발송 가이드

엑셀의 주소 데이터를 우편번호와 매칭한 뒤, 프린텍(Printec) 라벨지 규격에 맞춰 브라우저에서 바로 인쇄 가능한 출력물을 생성하기 위한 설계 및 구현 지침입니다.

## 목적
- 엑셀 주소 목록으로부터 우편번호를 자동 매칭.
- 라벨 규격(행×열, 라벨 크기, 여백/간격)에 맞춘 인쇄용 레이아웃 생성.
- 미매칭/오류 행의 분리 표시와 재시도 흐름 제공.

## 사용자 흐름
1) 엑셀 업로드 → 2) 주소→우편번호 매칭 진행(진행률 표시) → 3) 완료 시 “라벨 인쇄” 버튼 → 4) 라벨 템플릿/보정 선택 → 5) 미리보기 확인 → 6) 브라우저 인쇄.

## 데이터 요구사항
- 최소 컬럼: 주소 또는 주소1(필수), 수신자명(선택), 주소2/상세주소(선택).
- 자동 매핑 규칙(대소문자 무시, 부분 일치 허용):
  - 수신자명: ["이름","성명","수신자","name","recipient"] 중 우선 탐색.
  - 주소1: 기존 주소 컬럼 자동 탐색(기존 로직 재사용: 주소/주소지/address/addr 등).
  - 주소2: ["상세주소","주소2","address2","detail"]가 있으면 주소1 뒤에 결합.

## 백엔드 변경 사항

### 라벨 데이터 구조
매칭 완료 시 메모리에 라벨 데이터(필요 최소 필드)를 보관합니다.

```ts
type LabelItem = {
  name?: string;              // 수신자명(없으면 빈 문자열)
  postalCode: string;         // 매칭된 5자리 우편번호(없으면 빈 문자열)
  address1: string;           // 기본주소(정규화/표시용)
  address2?: string;          // 상세주소(선택)
  originalRow?: number;       // 원본 엑셀 행 번호(디버그/오류표시)
};
```

### 새 API
- GET `/api/file/labels/:jobId`
  - 설명: 지정 작업의 라벨용 데이터 반환
  - 응답 예시:
  ```json
  {
    "success": true,
    "data": {
      "jobId": "job_1700000000000_abcd",
      "total": 120,
      "labels": [
        {"name":"홍길동","postalCode":"06159","address1":"서울특별시 강남구 테헤란로 123","address2":"101동 202호","originalRow":2},
        {"name":"김철수","postalCode":"48058","address1":"부산광역시 해운대구 센텀로 456","address2":""}
      ],
      "errors": [
        {"row": 25, "address": "서울시 강남구 ...", "error": "우편번호를 찾을 수 없습니다."}
      ]
    }
  }
  ```

### 캐싱/성능
- 주소→우편번호 결과를 메모리 캐시에 저장(동일 주소 재요청 방지).
- 배치 처리 시 레이트리미팅 유지(기존 Kakao 10rps 규칙 준수).

### 미매칭/오류 처리
- `errors` 배열에 누적 보관, 라벨 인쇄 UI에서 별도 안내/다운로드 제공(CSV 등).

## 프론트엔드 변경 사항

### 인쇄 전용 페이지(`frontend/public/print.html`)
- 쿼리 파라미터: `jobId`, `template`, `startIndex`, `scale`, `marginX`, `marginY`.
- 라벨 아이템을 그리드(행×열)로 배치하고, 시작 위치 보정(startIndex) 지원.
- 텍스트 자동 줄바꿈/크기 축소(우편번호/이름/주소1/주소2 순으로 배치).

### 템플릿 프리셋(예시)
- 기본 제공 2종(필요 시 추가/수정):
  - `A4_3x8_70x50`: 3열×8행, 라벨 70×50mm, 상여백 10mm, 좌여백 7mm, 가로간격 3mm, 세로간격 0mm.
  - `A4_2x7_99x67`: 2열×7행, 라벨 99×67mm, 상여백 12mm, 좌여백 5mm, 가로간격 3mm, 세로간격 0mm.
- 실제 사용하는 프린텍 규격(mm)을 UI에서 입력/수정 가능하도록 제공.

### 보정 옵션
- `startIndex`: 이미 일부 사용한 라벨지의 시작 칸 지정(1부터 시작).
- `scale`: 전체 스케일(%) 조정으로 프린터/브라우저 스케일 편차 보정.
- `marginX`, `marginY`: 좌/상 여백(mm) 미세 보정.

### UX 연결
- 업로드 완료 화면에 “라벨 인쇄” 버튼 추가 → `print.html?jobId=...`로 이동.
- 미리보기에서 템플릿 선택/보정 후 “인쇄” 버튼 클릭.

## 인쇄 가이드(브라우저)
- 용지: A4, 여백: 없음(0), 배율: 100%(실제 크기), 머리글/바닥글: 비활성화.
- 배경 그래픽 인쇄는 필요 시 활성화(디자인 포함 시).
- 프린터 드라이버 설정과 브라우저 인쇄 설정이 중복되지 않도록 확인.

## 환경설정/포트
- 기본 포트: `3001`(백엔드), 프론트는 같은 서버에서 정적 서빙.
- `.env` 주요 항목: `KAKAO_API_KEY`, `PORT=3001`, `FRONTEND_URL`.
- Kakao API 미설정 시에도 Mock 데이터로 개발/테스트 가능(코드 반영됨).

## 향후 확장(선택)
- 서버 측 PDF 생성(pdfkit)으로 브라우저 없이도 라벨 PDF 배치 출력.
- 바코드/QR 삽입 옵션.
- 실패 주소 편집/재시도 UI.

## 구현 체크리스트
- [ ] 파일 처리 완료 시 라벨 데이터 생성/보관(Map) 추가
- [ ] GET `/api/file/labels/:jobId` 엔드포인트 구현
- [ ] `print.html` 페이지 및 템플릿 프리셋/보정 UI 구현
- [ ] 업로드 완료 화면에 “라벨 인쇄” 버튼 연결
- [ ] README에 라벨 인쇄 섹션/인쇄 가이드 추가
